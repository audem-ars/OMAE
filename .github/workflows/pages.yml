name: Deploy to GitHub Pages
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: site/package-lock.json

      - run: npm ci
        working-directory: site

      - run: npm run build
        working-directory: site

      - name: Assemble Pages artifact
        run: |
          set -e
          rm -rf public
          mkdir -p public/apps/current public/apps/publish/current

          cp -R site/dist/. public/apps/current/
          cp -R site/dist/. public/apps/publish/current/

          sed -E -i '/<base[^>]*>/d' public/apps/current/index.html
          sed -E -i '/<base[^>]*>/d' public/apps/publish/current/index.html

          cp public/apps/current/index.html public/apps/current/404.html
          cp public/apps/publish/current/index.html public/apps/publish/current/404.html

          sed -E -i 's|<a([^>]*?)href="[^"]*"([^>]*)>([[:space:]]*Get[[:space:]]*Started[[:space:]]*)</a>|<a\1 href="/OMAE/apps/current/get-started.html"\2>\3</a>|Ig' public/apps/current/index.html
          sed -E -i 's|<a([^>]*?)href="[^"]*"([^>]*)>([[:space:]]*Get[[:space:]]*Started[[:space:]]*)</a>|<a\1 href="/OMAE/apps/current/get-started.html"\2>\3</a>|Ig' public/apps/publish/current/index.html

          if [ ! -f public/apps/current/get-started.html ]; then
            cat > public/apps/current/get-started.html <<'HTML'
<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<title>Get Started – Acme</title>
<main style="max-width:720px;margin:40px auto;font-family:system-ui;line-height:1.5">
  <h1>Get Started</h1>
  <p>Welcome. This is a real page.</p>
  <p><a href="/OMAE/apps/current/">← Back</a></p>
</main>
HTML
          fi

          if [ ! -f public/apps/publish/current/get-started.html ]; then
            cat > public/apps/publish/current/get-started.html <<'HTML'
<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width">
<title>Get Started – Acme</title>
<main style="max-width:720px;margin:40px auto;font-family:system-ui;line-height:1.5">
  <h1>Get Started</h1>
  <p>Welcome. This is a real page.</p>
  <p><a href="/OMAE/apps/publish/current/">← Back</a></p>
</main>
HTML
          fi

      - uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
